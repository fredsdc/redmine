<% unless @role.new_record? %>
  <% flows = WorkflowRule.where(role_id: @role.id).map{|w| [w.role_id, w.tracker_id, w.workspace_id]}.uniq %>
  <% if flows.count > 0 %>
    <% workspaces = Workspace.pluck(:id, :name).to_h %>
    <% roles = Role.pluck(:id, :name).to_h %>
    <% trackers = Tracker.pluck(:id, :name).to_h %>
    <div id="workflows_dialog" style="display:none;">
      <fieldset class="box">
        <legend><%= l(:label_workflow_plural) %></legend>
        <i><span style="width: 160px; display: inline-block;"><%= l(:label_tracker) %></span><span style="width: 160px; display: inline-block;"><%= l(:label_workspace) %></span></i><br>
        <% flows.sort.each do |x| %>
        <%= link_to raw('<span style="width: 160px; display: inline-block;">'"#{trackers[x[1]]}"'</span><span style="width: 160px; display: inline-block;">'"#{workspaces[x[2]]}"'</span>'),
              workflows_edit_path(:role_id => x[0], :tracker_id => x[1], :workspace_id => x[2], :used_role_statuses_only => true, :used_statuses_only => true, :used_workspaces_only => true) %><br>
        <% end %>
      </fieldset>
    </div>
  <% end %>
  <% projects = Project.find(MemberRole.where(role_id: @role.id).compact.map{|m| m.member.project_id}) %>
  <% if projects.present? %>
    <div id="projects_dialog" style="display:none;">
      <fieldset class="box" id="tracker_project_ids">
        <legend><a class="status_1" onclick='cycleVisibility(this, [["<%= l(:label_all) %>","<%= l(:project_status_active_plural) %>","<%= l(:project_status_closed_plural) %>","<%= l(:project_status_archived_plural) %>"],["status_0", "status_1", "status_5", "status_9"]]);'><%= l(:label_project_plural) %> (<span><%= l(:project_status_active_plural) %></span>)</a></legend>
        <%= render_project_nested_lists(projects) do |p|
          link_to(p.name, project_path(p))
        end %>
      </fieldset>
    </div>
  <% end %>
  <% custom_fields = IssueCustomField.select{|c| c.visible? || c.roles.include?(@role)} %>
  <% if custom_fields.present? %>
  <div id="custom_fields_dialog" style="display:none;">
    <fieldset class="box">
      <legend><%= l(:label_custom_field_plural) %></legend>
      <% custom_fields.each do |custom_field| %>
      <%= link_to(custom_field.name, edit_custom_field_path(custom_field), :class => custom_field.css_classes).html_safe %>
      <br>
      <% end %>
    </fieldset>
  </div>
  <% end %>

<% end %>

<div class="contextual">
  <%= content_tag "a", l(:label_project_plural), {
      :onclick => "showModal('projects_dialog', '600px', '#{l(:label_role_plural)} » #{@role.name}')",
      :style => "cursor: pointer;",
      :class => "icon icon-projects"
    } if projects.present? %>
  <%= content_tag "a", l(:label_workflow_plural), {
      :onclick => "showModal('workflows_dialog', '600px', '#{l(:label_role_plural)} » #{@role.name}')",
      :style => "cursor: pointer;",
      :class => "icon icon-workflows"
    } if flows.present? %>
  <%= content_tag "a", l(:label_custom_field_plural), {
      :onclick => "showModal('custom_fields_dialog', '600px', '#{l(:label_role_plural)} » #{@role.name}')",
      :style => "cursor: pointer;",
      :class => "icon icon-custom-fields"
    } if custom_fields.present? %>
</div>
