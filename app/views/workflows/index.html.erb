<%= title [l(:label_workflow), workflows_edit_path], l(:field_summary) %>

<% if @roles.empty? || @trackers.empty? %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% else %>
  <p><label><%=l(:label_workspace)%>:<%= options_for_workflow_select 'workspace_id[]', Workspace.sorted, @workspaces, :id => 'workspace_id', :class => 'expandable', :onchange=>'refresh_table(this.value);' %></label></p>
  <% @workspaces.each do |workspace| %>
    <div class="autoscroll ws ws<%= workspace.id%>" style="display: none;">
      <table class="list">
        <thead>
          <tr>
            <th>
            </th>
            <% @roles.each do |role| %>
              <% next unless @workflow_counts.select{|i,v| i[1]==role.id && i[2]==workspace.id}.present? %>
              <th>
                <%= content_tag(role.builtin? ? 'em' : 'span', role.name) %>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @trackers.each do |tracker| -%>
          <% next unless @workflow_counts.select{|i,v| i[0]==tracker.id && i[2]==workspace.id}.present? %>
            <tr>
              <td class="name"><%= tracker.name %></td>
              <% @roles.each do |role| -%>
              <% next unless @workflow_counts.select{|i,v| i[1]==role.id && i[2]==workspace.id}.present? %>
                <td>
                  <% count = @workflow_counts[[tracker.id, role.id, workspace.id]] || 0 %>
                  <%= link_to((count > 0 ? count : content_tag(:span, nil, :class => 'icon-only icon-not-ok')),
                    {:action => 'edit', :role_id => role, :tracker_id => tracker, :workspace_id => workspace},
                    :title => l(:button_edit)) %>
                </td>
              <% end -%>
            </tr>
          <% end -%>
        </tbody>
      </table>
    </div>
  <% end %>
  <script>
    function refresh_table(value) {
      $('.ws').css("display","none");
      $('.ws' + value).toggle("display");
    }

    refresh_table(document.getElementById('workspace_id').value)
  </script>
<% end %>
