<fieldset class="box">
  <legend><%= toggle_checkboxes_link('.projects-selection input:enabled') %><%= l(:label_project_plural) %></legend>
  <div class="objects-selection">
    <div class="projects-selection">
    <%= render_project_nested_lists(@projects) do |p| %>
      <label>
        <%= check_box_tag('membership[project_ids][]', p.id, false, :id => nil, :disabled => @principal.member_of?(p), :ws => p.workspace_id) %> <%= p %>
      </label>
    <% end %>
    </div>
  </div>
</fieldset>

<fieldset class="box">
  <legend><%= toggle_checkboxes_link('.roles-selection input') %><%= l(:label_role_plural) %> (<a onclick='if($(".roles-selection label").size()==$(".roles-selection label :visible").size()){filter_proj_ws()}else{ $(".roles-selection label").show()};'><%= l(:label_all) %></a>)</legend>
  <div class="roles-selection" style="column-count: 4;">
  <% @roles.each do |role| %>
    <label<%= role_color_and_hide(role) %><%= " class=ro_#{role.id}" %> >
      <%= check_box_tag 'membership[role_ids][]', role.id, false, :id => nil %>
      <%= role %>
    </label>
  <% end %>
  </div>
</fieldset>

<%= javascript_tag do %>
  var wsJSON = <%=raw workspaces_json %>

  function filter_proj_ws() {
    if ($('.projects-selection :checked').size() > 0) {
      $('.roles-selection label').hide();
      $(wsJSON[0]).show();
      $('.projects-selection :checked').each(function () {
        $(wsJSON[$(this).attr('ws')]).show();
      });
    } else {
      $('.roles-selection label').show();
    }
  }

  $('.projects-selection input').click(filter_proj_ws);
<% end %>
